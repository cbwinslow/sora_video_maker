name: Code Quality Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze Codebase
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black isort pylint bandit safety
    
    - name: Run codebase analyzer
      run: |
        python scripts/codebase_analyzer.py --output codebase_analysis.md || echo "Codebase analysis failed"
    
    - name: Run auto-fix analyzer
      run: |
        python scripts/auto_fix_errors.py --analyze-only --report quality_analysis.md || echo "Auto-fix analysis failed"
    
    - name: Upload analysis reports
      uses: actions/upload-artifact@v3
      with:
        name: analysis-reports
        path: |
          codebase_analysis.md
          quality_analysis.md
    
    - name: Comment PR with analysis
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let comment = '## üìä Codebase Analysis\n\n';
          
          try {
            const codebaseAnalysis = fs.readFileSync('codebase_analysis.md', 'utf8');
            const qualityAnalysis = fs.readFileSync('quality_analysis.md', 'utf8');
            
            // Truncate reports if too large (GitHub comment limit is 65536 characters)
            const maxLength = 60000;
            let truncatedCodebase = codebaseAnalysis;
            let truncatedQuality = qualityAnalysis;
            
            if (codebaseAnalysis.length > maxLength) {
              truncatedCodebase = codebaseAnalysis.substring(0, maxLength) + '\n\n... (truncated due to size)';
            }
            if (qualityAnalysis.length > maxLength) {
              truncatedQuality = qualityAnalysis.substring(0, maxLength) + '\n\n... (truncated due to size)';
            }
            
            comment += '<details>\n<summary>View Codebase Analysis</summary>\n\n';
            comment += truncatedCodebase;
            comment += '\n</details>\n\n';
            
            comment += '<details>\n<summary>View Quality Analysis</summary>\n\n';
            comment += truncatedQuality;
            comment += '\n</details>\n';
          } catch (error) {
            comment += '‚ö†Ô∏è Error loading analysis reports\n';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
    
    - name: Create issue for critical findings
      if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          try {
            const qualityAnalysis = fs.readFileSync('quality_analysis.md', 'utf8');
            
            // Check if there are critical issues
            if (qualityAnalysis.includes('üî¥ HARD fixes:') && 
                !qualityAnalysis.includes('üî¥ HARD fixes: 0')) {
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üî¥ Critical Code Quality Issues Detected',
                body: qualityAnalysis,
                labels: ['code-quality', 'critical']
              });
            }
          } catch (error) {
            console.log('No critical issues found or error reading analysis');
          }
