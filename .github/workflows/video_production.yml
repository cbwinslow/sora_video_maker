name: Automated Video Production

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      topic:
        description: 'Specific topic to create video about (optional)'
        required: false
        default: ''
      num_videos:
        description: 'Number of videos to create'
        required: false
        default: '1'
      platforms:
        description: 'Platforms to upload to (comma-separated)'
        required: false
        default: 'youtube_shorts,tiktok'

jobs:
  video-production:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          sleep 10
          ollama pull llama2
      
      - name: Create config file
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          YOUTUBE_CLIENT_SECRETS: ${{ secrets.YOUTUBE_CLIENT_SECRETS }}
          TIKTOK_API_KEY: ${{ secrets.TIKTOK_API_KEY }}
        run: |
          cat > config/config.yaml << EOF
          api_keys:
            openai: "${OPENAI_API_KEY}"
            openrouter: "${OPENROUTER_API_KEY}"
            tiktok: "${TIKTOK_API_KEY}"
          
          video_generation:
            default_resolution: "1080x1920"
            default_fps: 30
            default_duration: 60
            output_format: "mp4"
            output_directory: "output/videos"
          
          research:
            sources:
              - "reddit"
              - "youtube"
              - "google_trends"
            topics_to_track: 10
          
          upload:
            enabled: true
            platforms:
              - "youtube_shorts"
              - "tiktok"
            max_videos_per_day: 5
          
          workflow:
            auto_generate: true
            auto_upload: true
            temp_directory: "temp"
            keep_temp_files: false
          
          ollama:
            host: "http://localhost:11434"
            default_model: "llama2"
          EOF
      
      - name: Run Video Production Crew
        run: |
          python crews/video_production_crew.py
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: video-outputs
          path: |
            output/videos/
            output/trends/
            logs/
          retention-days: 7
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "Video production workflow failed"
          # Add notification logic here (Slack, email, etc.)
  
  short-form-production:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create short-form content
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TIKTOK_API_KEY: ${{ secrets.TIKTOK_API_KEY }}
        run: |
          # Create config
          cat > config/config.yaml << EOF
          api_keys:
            openai: "${OPENAI_API_KEY}"
            tiktok: "${TIKTOK_API_KEY}"
          
          upload:
            enabled: true
            platforms:
              - "tiktok"
              - "youtube_shorts"
              - "instagram_reels"
          EOF
          
          # Run short-form production
          python -c "
          import asyncio
          from crews.video_production_crew import ShortFormCrew
          import yaml
          
          with open('config/config.yaml') as f:
              config = yaml.safe_load(f)
          
          crew = ShortFormCrew(config)
          result = asyncio.run(crew.create_short_form('AI Technology Trends', duration=30))
          print(result)
          "
      
      - name: Upload short-form artifacts
        uses: actions/upload-artifact@v3
        with:
          name: short-form-videos
          path: output/videos/
          retention-days: 3
