name: Auto Fix Code Quality Issues

on:
  workflow_dispatch:
    inputs:
      tier:
        description: 'Fix tier (easy/medium/all)'
        required: true
        default: 'easy'
        type: choice
        options:
          - easy
          - medium
          - all
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  auto-fix:
    name: Auto Fix (${{ github.event.inputs.tier || 'easy' }})
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort pylint bandit autoflake
    
    - name: Run auto-fix script
      run: |
        python scripts/auto_fix_errors.py \
          --tier ${{ github.event.inputs.tier || 'easy' }} \
          --report quality_report.md
    
    - name: Check for changes
      id: changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add -A
        git commit -m "chore: auto-fix ${{ github.event.inputs.tier || 'easy' }} code quality issues"
    
    - name: Create Pull Request
      if: steps.changes.outputs.has_changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: auto-fix code quality issues"
        title: "ðŸ¤– Auto-fix ${{ github.event.inputs.tier || 'easy' }} code quality issues"
        body: |
          ## Auto-Generated Code Quality Fixes
          
          This PR contains automated fixes for ${{ github.event.inputs.tier || 'easy' }} tier code quality issues.
          
          ### Changes Made
          
          - Fixed whitespace and formatting issues
          - Removed unused imports
          - Applied code style fixes
          
          ### Quality Report
          
          See attached quality_report.md for details.
          
          ---
          
          *This PR was automatically generated by the Auto Fix workflow.*
        branch: auto-fix-${{ github.event.inputs.tier || 'easy' }}-${{ github.run_number }}
        delete-branch: true
    
    - name: Upload quality report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: quality-report
        path: quality_report.md
